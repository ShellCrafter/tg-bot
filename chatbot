# -----------------------------
# Telegram Bot (Termux Edition)
# Clean Version + Smart AI + Typing Effect
# Works for python-telegram-bot v20+
# -----------------------------

import os
import requests
from datetime import datetime
from bs4 import BeautifulSoup
import random
import asyncio

from telegram import (
    Update,
    InlineKeyboardButton,
    InlineKeyboardMarkup,
)
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    CallbackQueryHandler,
    ContextTypes,
    filters,
)

# -----------------------------
# BOT TOKEN
# -----------------------------
BOT_TOKEN = "YOUR_BOT_TOKEN_HERE"


# -----------------------------
# TYPING EFFECT
# -----------------------------
async def type_message(update: Update, context: ContextTypes.DEFAULT_TYPE, text: str):
    """Send typing animation + message."""
    await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
    await asyncio.sleep(0.5)
    await update.message.reply_text(text)


# -----------------------------
# START
# -----------------------------
async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await type_message(update, context, "ğŸ‘‹ Hello! Welcome.\nType /help to see all commands.")


# -----------------------------
# HELP MENU
# -----------------------------
async def help_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = (
        "ğŸ“Œ *Available Commands:*\n"
        "/start - Start bot\n"
        "/help - Help\n"
        "/time - Current time\n"
        "/info - Your info\n"
        "/calc 10+5 - Calculator\n"
        "/menu - Show buttons\n"
        "/title url - Get website title\n"
        "/joke - Random joke\n\n"
        "âœ¨ *AI Chat:* Just type normally."
    )
    await update.message.reply_text(text, parse_mode="Markdown")


# -----------------------------
# TIME
# -----------------------------
async def time_cmd(update: Update, context: ContextTypes.DEFAULT_TYPE):
    now = datetime.now().strftime("%d-%m-%Y  %H:%M:%S")
    await type_message(update, context, f"â±ï¸ Current Time:\n{now}")


# -----------------------------
# USER INFO
# -----------------------------
async def info(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.effective_user
    text = (
        f"ğŸ‘¤ Name: {user.first_name}\n"
        f"ğŸ†” User ID: {user.id}\n"
        f"ğŸŒ Username: @{user.username}"
    )
    await update.message.reply_text(text)


# -----------------------------
# CALCULATOR
# -----------------------------
async def calc(update: Update, context: ContextTypes.DEFAULT_TYPE):
    expr = " ".join(context.args)
    try:
        result = eval(expr)
        await update.message.reply_text(f"ğŸ§® Result: {result}")
    except:
        await update.message.reply_text("âŒ Use format: /calc 5*5")


# -----------------------------
# MENU BUTTONS
# -----------------------------
async def menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [
        [InlineKeyboardButton("ğŸ“¸ Random Photo", callback_data="photo")],
        [InlineKeyboardButton("â„¹ï¸ About", callback_data="about")],
    ]
    await update.message.reply_text("Choose an option:", reply_markup=InlineKeyboardMarkup(keyboard))


async def button_handler(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    data = query.data

    if data == "photo":
        await query.message.reply_photo("https://picsum.photos/600")

    elif data == "about":
        await query.message.reply_text("ğŸ¤– I'm a simple Termux bot with AI replies.")

    await query.answer()


# -----------------------------
# SAVE FILE
# -----------------------------
async def save_file(update: Update, context: ContextTypes.DEFAULT_TYPE):
    file = update.message.document
    folder = "downloads"
    os.makedirs(folder, exist_ok=True)

    await file.get_file().download_to_drive(f"{folder}/{file.file_name}")
    await update.message.reply_text("ğŸ“ File saved successfully!")


# -----------------------------
# WEBSITE TITLE
# -----------------------------
async def title(update: Update, context: ContextTypes.DEFAULT_TYPE):
    url = " ".join(context.args)
    try:
        r = requests.get(url, timeout=5)
        soup = BeautifulSoup(r.text, "html.parser")
        await update.message.reply_text(f"ğŸ”– Title:\n{soup.title.string}")
    except:
        await update.message.reply_text("âŒ Unable to fetch title!")


# -----------------------------
# RANDOM JOKE
# -----------------------------
async def joke(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        j = requests.get("https://official-joke-api.appspot.com/random_joke").json()
        await update.message.reply_text(f"ğŸ˜‚ {j['setup']}\nğŸ¤£ {j['punchline']}")
    except:
        await update.message.reply_text("âŒ Joke API error!")


# -----------------------------
# AI CHATBOT (RULE-BASED)
# -----------------------------
responses = {
    ("hi", "hello", "hey", "yo"): [
        "Hello! ğŸ‘‹",
        "Hey there ğŸ˜Š",
        "Hi! Need help?"
    ],
    ("how are you", "how r u", "h r u"): [
        "I'm doing great! What about you?",
        "Feeling awesome today ğŸ˜",
        "I'm fine! Thanks for asking ğŸ˜Š"
    ],
    ("your name", "who are you"): [
        "I'm a Telegram bot ğŸ¤–",
        "I'm your friendly assistant!",
    ],
    ("sad", "unhappy", "depressed"): [
        "I'm here for you â¤ï¸",
        "Everything will be okay.",
    ],
    ("love", "i love you"): [
        "Aww ğŸ˜³â¤ï¸",
        "Love is beautiful â¤ï¸"
    ],
    ("bye", "good night", "gn"): [
        "Goodbye! ğŸ‘‹",
        "Good night ğŸŒ™"
    ],
    ("thank", "thanks"): [
        "You're welcome ğŸ˜Š",
        "Anytime â¤ï¸"
    ],
}

default_ai = [
    "Interesting... tell me more!",
    "Hmm, I see ğŸ‘€",
    "Really? Go on!",
    "I'm listening ğŸ˜Š",
]


async def ai_chat(update: Update, context: ContextTypes.DEFAULT_TYPE):
    text = update.message.text.lower()

    # typing animation
    await context.bot.send_chat_action(chat_id=update.effective_chat.id, action="typing")
    await asyncio.sleep(0.4)

    for keys, replies in responses.items():
        for k in keys:
            if k in text:
                await update.message.reply_text(random.choice(replies))
                return

    await update.message.reply_text(random.choice(default_ai))


# -----------------------------
# MAIN BOT
# -----------------------------
def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    app.add_handler(CommandHandler("start", start))
    app.add_handler(CommandHandler("help", help_cmd))
    app.add_handler(CommandHandler("time", time_cmd))
    app.add_handler(CommandHandler("info", info))
    app.add_handler(CommandHandler("calc", calc))
    app.add_handler(CommandHandler("menu", menu))
    app.add_handler(CommandHandler("joke", joke))
    app.add_handler(CommandHandler("title", title))

    app.add_handler(CallbackQueryHandler(button_handler))
    app.add_handler(MessageHandler(filters.Document.ALL, save_file))

    # AI Chat
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, ai_chat))

    app.run_polling()


# -----------------------------
# RUN
# -----------------------------
if __name__ == "__main__":
    main()
